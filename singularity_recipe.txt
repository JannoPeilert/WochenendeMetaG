# A singularity container for miniconda and wochenende
# Adapted from https://hpc.nih.gov/apps/singularity.html
# Colin Davenport June 2020

#BootStrap: docker
#From: continuumio/miniconda3:latest
Bootstrap: debootstrap 
IncludeCmd: yes 
OSVersion: focal
MirrorURL: http://de.archive.ubuntu.com/ubuntu/

## TODO
## Use ubuntu 2004 NOT contininuumio which uses debian
## Errors - conda not in PATH. Use full path variable, 
## conda exec /opt/miniconda3/bin/conda

%files
 

%post
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# this will install all necessary packages and prepare the container
    mkdir /data /resources

    # debootstrap will only find packages from one apt source, this is the workaround
    sed -i 's/$/ universe/' /etc/apt/sources.list

    # try to speed up R package compliation (success, now 10-15m, was 30-45m)
    #echo "options(Ncpus = 24)" > ~/.Rprofile

    # In order to get locales working properly inside a Singularity container
    # we need to do the following:
    apt-get update && apt-get install -y \
            locales language-pack-fi language-pack-en
            export LANGUAGE=en_US.UTF-8 && \
            export LANG=en_US.UTF-8 && \
            export LC_ALL=en_US.UTF-8 && \
            locale-gen en_US.UTF-8 && \
            dpkg-reconfigure locales


    # generate users
    groupadd rcug -g 9415
    useradd -s /bin/bash rcug -u 9415 -g 9415 -m

    apt-get -y update
    apt-get -y install make gcc zlib1g-dev libncurses5-dev samtools git wget bash

    # Miniconda3. 
    cd /opt/
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh 
    chmod a+x miniconda.sh
#    bash miniconda.sh -b -p /opt/conda
     # untested
     #bash -i miniconda.sh -b -p /opt/conda

     # from vsoch, untested 
     #bash Anaconda3-4.2.0-Linux-x86_64.sh -b -p /opt/anaconda3
     bash miniconda.sh -b -p /opt/miniconda3
     echo "PATH=/opt/miniconda3/bin:$PATH" >> $HOME/.bashrc
     echo "export PATH" >> $HOME/.bashrc
     #rm miniconda.sh
     #. $HOME/.bashrc
     #bash -i miniconda.sh -b -p /opt/conda

     # Add bash env
     echo "PATH=/opt/miniconda3/bin:$PATH" >> $HOME/bashenv
     echo "export $PATH" >> $HOME/bashenv

    # Conda problems can be solved using "bash -i x.sh" to read the .bashrc.  
    # No good solution yet? https://stackoverflow.com/questions/59665231/conda-4-7-how-to-activate-env-in-bash-script

    #eval "$(/opt/conda/bin/conda shell.bash hook)"

     #untested
     #source /opt/conda/etc/profile.d/conda.sh
#    conda init bash
#    . /opt/conda/bin/
#    /opt/conda/bin/conda activate > /dev/null

    # clone Wochenende
    cd /data
    git clone https://github.com/MHH-RCUG/wochenende.git
    cd /data/wochenende
    # setup env variablesv in ~/.bashrc
    bash setup.sh
    
    /opt/miniconda3/bin/conda env create -f env.wochenende.minimal.yml
    /opt/miniconda3/bin/conda clean --index-cache --tarballs --packages --yes




%runscript

    /opt/miniconda3/bin/conda init bash
    . /opt/miniconda3/etc/profile.d/conda.sh

    #exec /opt/miniconda3/envs/$(head -n 1 environment.yml | cut -f 2 -d ' ')/bin/"$@"
    /opt/miniconda3/bin/conda activate wochenende > /dev/null



%environment

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# This sets global environment variables for anything run within the container (but for an old pre 2020 conda version!)
unset CONDA_DEFAULT_ENV
export PATH="/opt/miniconda3/bin:$PATH:"
export CONDA_HOME=/opt/miniconda3/
export CONDA_EXE=/opt/miniconda3/bin/conda 
export CONDA_PREFIX=/opt/miniconda3/
export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
export CONDA_DEFAULT_ENV=wochenende
export BASH_ENV=$HOME/bashenv


